<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Goats in the Wild Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MapLibre (open-source Mapbox GL) -->
  <link
    href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #05060a;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Goat pin icon */
    .goat-marker {
      width: 32px;
      height: 32px;
      background-image: url("https://static.wixstatic.com/shapes/691d3d_aff2f307292048489b5fed6691eb63a1.svg");
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
    }

    .mapboxgl-popup {
      max-width: 260px !important;
      font-size: 12px;
    }

    .mapboxgl-popup-content {
      background: #12131a;
      color: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #2c2f3b;
      padding: 8px 10px;
    }

    .mapboxgl-popup-content a {
      color: #66c2ff;
      text-decoration: none;
    }

    .mapboxgl-popup-content a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --- CONFIG ---
    // Dark-ish basemap style (vector tiles) from OpenFreeMap / OpenMapTiles
    // This "liberty" style is a clean, general-purpose map. Later you can
    // switch to a fully dark custom style if you want to go harder.
    const MAP_STYLE_URL = "https://tiles.openfreemap.org/styles/liberty";

    let map;
    let markers = [];

    function initMap(center) {
      const initialCenter = center || [0, 20]; // [lng, lat]
      const initialZoom = 2;

      map = new maplibregl.Map({
        container: "map",
        style: MAP_STYLE_URL,
        center: initialCenter,
        zoom: initialZoom,
      });

      // Optional: disable rotation if you want a cleaner UX
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();

      // Add zoom controls (can remove if you want ultraminimal)
      map.addControl(new maplibregl.NavigationControl(), "bottom-right");
    }

    function clearMarkers() {
      markers.forEach((m) => m.remove());
      markers = [];
    }

    function addGoatMarkers(goats) {
      if (!map) {
        // If map not initialised yet, start it around first goat
        const first = goats && goats.length
          ? [goats[0].lng, goats[0].lat]
          : [0, 20];
        initMap(first);

        map.on("load", () => {
          actuallyAddMarkers(goats);
        });
      } else if (!map.loaded()) {
        map.on("load", () => {
          actuallyAddMarkers(goats);
        });
      } else {
        actuallyAddMarkers(goats);
      }
    }

    function actuallyAddMarkers(goats) {
      clearMarkers();

      if (!goats || !goats.length) return;

      const bounds = new maplibregl.LngLatBounds();

      goats.forEach((goat) => {
        if (typeof goat.lat !== "number" || typeof goat.lng !== "number") {
          return;
        }

        const el = document.createElement("div");
        el.className = "goat-marker";

        const popupHtml = `
          <div>
            <strong>${escapeHtml(goat.title || "Goat in the Wild")}</strong><br/>
            ${goat.city ? escapeHtml(goat.city) + ", " : ""}
            ${goat.country ? escapeHtml(goat.country) : ""}<br/>
            ${
              goat.subtitle
                ? `<div style="margin-top:4px;">${escapeHtml(goat.subtitle)}</div>`
                : ""
            }
            ${
              goat.link
                ? `<div style="margin-top:6px;"><a href="${goat.link}" target="_blank" rel="noopener noreferrer">View goat page</a></div>`
                : ""
            }
          </div>
        `;

        const popup = new maplibregl.Popup({ offset: 24 }).setHTML(popupHtml);

        const marker = new maplibregl.Marker({ element: el })
          .setLngLat([goat.lng, goat.lat])
          .setPopup(popup)
          .addTo(map);

        markers.push(marker);
        bounds.extend([goat.lng, goat.lat]);
      });

      if (goats.length === 1) {
        map.flyTo({
          center: [goats[0].lng, goats[0].lat],
          zoom: 5,
          essential: true,
        });
      } else {
        map.fitBounds(bounds, {
          padding: 40,
          maxZoom: 4.5,
          duration: 1000,
        });
      }
    }

    // Receive data from Wix page
    window.addEventListener("message", (event) => {
      try {
        const data =
          typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        if (!data || data.type !== "GOAT_LOCATIONS") return;

        const goats = Array.isArray(data.payload) ? data.payload : [];
        addGoatMarkers(goats);
      } catch (e) {
        console.error("Error handling message from parent:", e);
      }
    });

    // Init empty map so thereâ€™s no blank area before data arrives
    initMap();

    // Simple HTML escape to avoid XSS from CMS
    function escapeHtml(str) {
      if (!str || typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
