<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GOATS in the Wild Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster plugin (for overlapping markers / clustering) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script
    src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
  ></script>

  <style>
    /* ---------- Custom fonts from your GitHub repo ---------- */
    @font-face {
      font-family: "American Captain";
      src: url("https://raw.githubusercontent.com/BSMediaGroup/Resources/master/FONTS/American%20Captain.otf")
        format("opentype");
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: "GemunuLibre-Regular";
      src: url("https://raw.githubusercontent.com/BSMediaGroup/Resources/master/FONTS/GemunuLibre-Regular.otf")
        format("opentype");
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: "GemunuLibre-SemiBold";
      src: url("https://raw.githubusercontent.com/BSMediaGroup/Resources/master/FONTS/GemunuLibre-SemiBold.otf")
        format("opentype");
      font-weight: 600;
      font-style: normal;
    }

    @font-face {
      font-family: "GemunuLibre-ExtraBold";
      src: url("https://raw.githubusercontent.com/BSMediaGroup/Resources/master/FONTS/GemunuLibre-ExtraBold.otf")
        format("opentype");
      font-weight: 800;
      font-style: normal;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #05060a;
      overflow: hidden;
      font-family: "GemunuLibre-Regular", system-ui, -apple-system,
        BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .goat-popup {
      font-size: 12px;
      color: #f5f5f5;
      font-family: "GemunuLibre-Regular", system-ui, -apple-system,
        BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .goat-popup a {
      color: #8CC736;
      text-decoration: none;
      font-family: "GemunuLibre-SemiBold", "GemunuLibre-Regular", system-ui,
        -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .goat-popup a:hover {
      text-decoration: underline;
    }

    /* Dark theme popups */
    .leaflet-popup-content-wrapper {
      background-color: #111;
      color: #f5f5f5;
      border-radius: 10px;
    }

    .leaflet-popup-tip {
      background-color: #111;
    }

    /* Marker bounce on initial load (using margin-top so Leaflet transforms are untouched) */
    @keyframes goat-bounce {
      0%, 20%, 50%, 80%, 100% {
        margin-top: 0;
      }
      40% {
        margin-top: -8px;
      }
      60% {
        margin-top: -4px;
      }
    }

    .leaflet-marker-icon.goat-bounce {
      animation: goat-bounce 0.5s ease-out;
      transform-origin: center bottom;
    }

    /* Marker cluster styling (gold circle + black centre, gold text) */
    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background-color: rgba(243, 174, 0, 0.85);
    }

    .marker-cluster div {
      background-color: #000;
      border-radius: 50%;
      border: 2px solid #f3ae00;
      color: #f3ae00;
      font-weight: 700;
      font-size: 13px;
      line-height: 32px;
      width: 32px;
      height: 32px;
      text-align: center;
      box-shadow: 0 0 6px rgba(0,0,0,0.6);
      font-family: "GemunuLibre-ExtraBold", system-ui, -apple-system,
        BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .marker-cluster span {
      line-height: 32px;
    }

    .marker-cluster:hover div {
      transform: scale(1.08);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ===== CONFIG =====
    const DEFAULT_GOAT_ICON_URL =
      "https://static.wixstatic.com/shapes/691d3d_aff2f307292048489b5fed6691eb63a1.svg";

    const SITE_BASE_URL = "https://www.thirdrailify.com";

    // Map country codes to full names when we only get initialisms
    const COUNTRY_NAMES = {
      // North America
      US: "United States",
      USA: "United States",
      CA: "Canada",
      MX: "Mexico",
    
      // South America
      AR: "Argentina",
      BO: "Bolivia",
      BR: "Brazil",
      CL: "Chile",
      CO: "Colombia",
      EC: "Ecuador",
      GY: "Guyana",
      PY: "Paraguay",
      PE: "Peru",
      SR: "Suriname",
      UY: "Uruguay",
      VE: "Venezuela",
    
      // Europe
      GB: "United Kingdom",
      UK: "United Kingdom",
      IE: "Ireland",
      FR: "France",
      DE: "Germany",
      NL: "Netherlands",
      BE: "Belgium",
      LU: "Luxembourg",
      ES: "Spain",
      PT: "Portugal",
      IT: "Italy",
      CH: "Switzerland",
      AT: "Austria",
      DK: "Denmark",
      NO: "Norway",
      SE: "Sweden",
      FI: "Finland",
      IS: "Iceland",
      GR: "Greece",
      PL: "Poland",
      CZ: "Czech Republic",
      SK: "Slovakia",
      HU: "Hungary",
      RO: "Romania",
      BG: "Bulgaria",
      HR: "Croatia",
      RS: "Serbia",
      SI: "Slovenia",
      BA: "Bosnia and Herzegovina",
      ME: "Montenegro",
      MK: "North Macedonia",
      AL: "Albania",
      LT: "Lithuania",
      LV: "Latvia",
      EE: "Estonia",
      UA: "Ukraine",
      BY: "Belarus",
      MD: "Moldova",
    
      // Middle East / West Asia
      TR: "Turkey",
      CY: "Cyprus",
      IL: "Israel",
      PS: "Palestine",
      LB: "Lebanon",
      SY: "Syria",
      JO: "Jordan",
      IQ: "Iraq",
      SA: "Saudi Arabia",
      KW: "Kuwait",
      QA: "Qatar",
      AE: "United Arab Emirates",
      OM: "Oman",
      BH: "Bahrain",
      YE: "Yemen",
      AM: "Armenia",
      GE: "Georgia",
      AZ: "Azerbaijan",
    
      // Central Asia
      KZ: "Kazakhstan",
      KG: "Kyrgyzstan",
      TJ: "Tajikistan",
      TM: "Turkmenistan",
      UZ: "Uzbekistan",
    
      // South Asia
      IN: "India",
      PK: "Pakistan",
      BD: "Bangladesh",
      LK: "Sri Lanka",
      NP: "Nepal",
      BT: "Bhutan",
      MV: "Maldives",
      AF: "Afghanistan",
    
      // East Asia
      CN: "China",
      JP: "Japan",
      KR: "South Korea",
      KP: "North Korea",
      TW: "Taiwan",
      MN: "Mongolia",
    
      // Southeast Asia
      ID: "Indonesia",
      MY: "Malaysia",
      SG: "Singapore",
      TH: "Thailand",
      VN: "Vietnam",
      KH: "Cambodia",
      LA: "Laos",
      MM: "Myanmar",
      PH: "Philippines",
      BN: "Brunei",
      TL: "Timor-Leste",
    
      // Oceania
      AU: "Australia",
      NZ: "New Zealand",
      FJ: "Fiji",
      PG: "Papua New Guinea",
      WS: "Samoa",
      TO: "Tonga",
      SB: "Solomon Islands",
      VU: "Vanuatu",
      MH: "Marshall Islands",
      KI: "Kiribati",
      TV: "Tuvalu",
      NR: "Nauru",
      PW: "Palau",
    
      // Africa
      ZA: "South Africa",
      EG: "Egypt",
      MA: "Morocco",
      DZ: "Algeria",
      TN: "Tunisia",
      LY: "Libya",
      SD: "Sudan",
      SS: "South Sudan",
      ET: "Ethiopia",
      SO: "Somalia",
      KE: "Kenya",
      UG: "Uganda",
      TZ: "Tanzania",
      RW: "Rwanda",
      BI: "Burundi",
      CD: "Democratic Republic of the Congo",
      CG: "Republic of the Congo",
      GA: "Gabon",
      CM: "Cameroon",
      CF: "Central African Republic",
      TD: "Chad",
      NE: "Niger",
      NG: "Nigeria",
      BJ: "Benin",
      TG: "Togo",
      GH: "Ghana",
      CI: "Côte d’Ivoire",
      LR: "Liberia",
      SL: "Sierra Leone",
      GN: "Guinea",
      GW: "Guinea-Bissau",
      ML: "Mali",
      MR: "Mauritania",
      SN: "Senegal",
      GM: "The Gambia",
      BF: "Burkina Faso",
      NA: "Namibia",
      BW: "Botswana",
      ZM: "Zambia",
      ZW: "Zimbabwe",
      MZ: "Mozambique",
      MG: "Madagascar",
      MU: "Mauritius",
      SC: "Seychelles",
      KM: "Comoros",
      ER: "Eritrea",
      DJ: "Djibouti",
      GQ: "Equatorial Guinea",
      ST: "São Tomé and Príncipe",
      LS: "Lesotho",
      SZ: "Eswatini",
      AO: "Angola",
      EH: "Western Sahara",
    
      // Caribbean
      CU: "Cuba",
      DO: "Dominican Republic",
      HT: "Haiti",
      JM: "Jamaica",
      TT: "Trinidad and Tobago",
      BB: "Barbados",
      BS: "Bahamas",
      AG: "Antigua and Barbuda",
      GD: "Grenada",
      LC: "Saint Lucia",
      VC: "Saint Vincent and the Grenadines",
      DM: "Dominica",
      KN: "Saint Kitts and Nevis",
    
      // Central America
      GT: "Guatemala",
      BZ: "Belize",
      SV: "El Salvador",
      HN: "Honduras",
      NI: "Nicaragua",
      CR: "Costa Rica",
      PA: "Panama"
    };


    const defaultIcon = L.icon({
      iconUrl: DEFAULT_GOAT_ICON_URL,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    let map;
    let markerCluster;
    let markers = [];

    function initMap() {
      console.log("[GoatMap] Initialising Leaflet map...");

      map = L.map("map", {
        zoomControl: true,
        worldCopyJump: true,
        maxBounds: [[-85, -180], [85, 180]],   // restrict vertical panning
        maxBoundsViscosity: 1.0,               // hard "rubber band" at edges
        minZoom: 2,
        maxZoom: 6                              // cap zoom so tiles / world don't expose white gaps
      }).setView([20, 0], 2);

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 6,          // match map's maxZoom to avoid blank tiles at crazy zoom
          minZoom: 2
        }
      ).addTo(map);

      // Cluster group to handle overlapping markers + zoom-level clusters
      markerCluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnEveryZoom: false,
        spiderfyOnMaxZoom: true,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 60
      });

      map.addLayer(markerCluster);
    }

    function clearMarkers() {
      if (markerCluster) {
        markerCluster.clearLayers();
      }
      markers = [];
    }

    // Round coordinates so we effectively only show city-ish precision
    function quantizeCoord(value, decimals = 2) {
      let num = typeof value === "number" ? value : Number(value);
      if (!isFinite(num)) return value;
      const factor = Math.pow(10, decimals);
      return Math.round(num * factor) / factor;
    }

    function addGoatMarkers(goats) {
      console.log("[GoatMap] addGoatMarkers called with", goats);
      if (!map) {
        initMap();
      }

      clearMarkers();

      if (!goats || !goats.length) {
        console.warn("[GoatMap] No goat locations to display.");
        return;
      }

      const bounds = [];

      goats.forEach((goat) => {
        if (!goat) return;

        let lat = quantizeCoord(goat.lat, 2);
        let lng = quantizeCoord(goat.lng, 2);

        if (!isFinite(lat) || !isFinite(lng)) {
          console.warn("[GoatMap] Skipping goat with invalid coords:", goat);
          return;
        }

        // Per-goat icon (if ever used)
        let markerIcon = defaultIcon;
        if (goat.iconUrl && goat.iconUrl.length > 5) {
          markerIcon = L.icon({
            iconUrl: goat.iconUrl,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          });
        }

        const name = goat.uploaderName || goat.title || "GOAT in the Wild";

        // Expand country names if we were given a code
        const rawCountry = goat.country || "";
        let countryText = rawCountry;
        if (rawCountry && rawCountry.length <= 3) {
          const upper = rawCountry.toUpperCase();
          countryText = COUNTRY_NAMES[upper] || rawCountry;
        }

        const locationText = [
          goat.city ? escapeHtml(goat.city) : "",
          countryText ? escapeHtml(countryText) : ""
        ]
          .filter(Boolean)
          .join(", ");

        // Flag: only if the original was a 2-letter code
        let flagImgHtml = "";
        if (rawCountry && rawCountry.length === 2) {
          const code = rawCountry.toLowerCase();
          const flagUrl = `https://flagcdn.com/24x18/${code}.png`;
          flagImgHtml = `<img src="${flagUrl}" alt="${escapeHtml(
            countryText
          )} flag"
                              style="width:18px;height:13px;object-fit:cover;border-radius:2px;margin-left:4px;flex-shrink:0;" />`;
        }

        // Build absolute page link
        let linkHref = goat.link || "";
        if (linkHref.startsWith("/")) {
          linkHref = SITE_BASE_URL + linkHref;
        }

        const popupHtml = `
          <div class="goat-popup">
            <div style="display:flex; gap:8px; align-items:flex-start;">
              ${
                goat.photo
                  ? `<img src="${goat.photo}" alt="${escapeHtml(name)}"
                        style="width:100px;height:100px;object-fit:cover;border-radius:6px;flex-shrink:0;" />`
                  : ""
              }
              <div style="max-width:220px;">
                <div style="
                  font-weight:600;
                  font-size:18px;
                  margin-bottom:2px;
                  font-family:'American Captain','GemunuLibre-SemiBold',
                    system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
                ">
                  ${escapeHtml(name)}
                </div>
                ${
                  locationText
                    ? `<div style="
                         font-size:11px;
                         opacity:0.85;
                         margin-bottom:3px;
                         display:flex;
                         align-items:center;
                         gap:4px;
                         font-family:'GemunuLibre-SemiBold','GemunuLibre-Regular',
                           system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
                       ">
                         <span>${locationText}</span>
                         ${flagImgHtml}
                       </div>`
                    : ""
                }
                ${
                  goat.subtitle
                    ? `<div style="
                         margin-top:2px;
                         opacity:0.9;
                         font-family:'GemunuLibre-Regular',system-ui,-apple-system,
                           BlinkMacSystemFont,'Segoe UI',sans-serif;
                       ">
                         ${escapeHtml(goat.subtitle)}
                       </div>`
                    : ""
                }
                ${
                  linkHref
                    ? `<div style="margin-top:6px;">
                         <a href="${linkHref}" target="_blank" rel="noopener noreferrer">
                           View goat page
                         </a>
                       </div>`
                    : ""
                }
              </div>
            </div>
          </div>
        `;

        const marker = L.marker([lat, lng], { icon: markerIcon }).bindPopup(
          popupHtml
        );

        // No hover scaling, no click animation – just add to cluster
        markerCluster.addLayer(marker);
        markers.push(marker);
        bounds.push([lat, lng]);
      });

      if (bounds.length === 1) {
        map.setView(bounds[0], 5);
      } else if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      // Trigger one-time bounce for all visible markers shortly after they render
      setTimeout(() => {
        markers.forEach((marker) => {
          const el = marker.getElement();
          if (el) {
            el.classList.add("goat-bounce");
            setTimeout(() => {
              el.classList.remove("goat-bounce");
            }, 550);
          }
        });
      }, 400);
    }

    // Listen for messages from Wix (parent)
    window.addEventListener("message", (event) => {
      try {
        console.log("[GoatMap] message event from parent:", event.origin, event.data);
        const data =
          typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        if (!data || data.type !== "GOAT_LOCATIONS") return;

        const goats = Array.isArray(data.payload) ? data.payload : [];
        addGoatMarkers(goats);
      } catch (e) {
        console.error("[GoatMap] Error handling message from parent:", e);
      }
    });

    // init empty dark map immediately
    initMap();

    function escapeHtml(str) {
      if (!str || typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
