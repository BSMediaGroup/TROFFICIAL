<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GOATS in the Wild Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #05060a;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .goat-popup {
      font-size: 12px;
      color: #f5f5f5;
    }

    .goat-popup a {
      color: #66c2ff;
      text-decoration: none;
    }

    .goat-popup a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ===== CONFIG =====
    // default global goat icon (used if CMS doesn't provide one)
    const DEFAULT_GOAT_ICON_URL =
      "https://static.wixstatic.com/shapes/691d3d_aff2f307292048489b5fed6691eb63a1.svg"; // TODO: replace with your actual goat pin

    const defaultIcon = L.icon({
      iconUrl: DEFAULT_GOAT_ICON_URL,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    let map;
    let markers = [];

    function initMap() {
      map = L.map("map", {
        zoomControl: true,
        worldCopyJump: true
      }).setView([20, 0], 2);

      // Dark basemap with minimal labels
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 19
        }
      ).addTo(map);
    }

    function clearMarkers() {
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
    }

    function addGoatMarkers(goats) {
      if (!map) {
        initMap();
      }

      clearMarkers();

      if (!goats || !goats.length) return;

      const bounds = [];

      goats.forEach((goat) => {
        if (typeof goat.lat !== "number" || typeof goat.lng !== "number") {
          return;
        }

        // per-goat icon if provided from CMS
        let markerIcon = defaultIcon;
        if (goat.iconUrl && goat.iconUrl.length > 5) {
          markerIcon = L.icon({
            iconUrl: goat.iconUrl,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          });
        }

        const popupHtml = `
          <div class="goat-popup">
            <strong>${escapeHtml(goat.title || "GOAT in the Wild")}</strong><br/>
            ${goat.city ? escapeHtml(goat.city) + ", " : ""}
            ${goat.country ? escapeHtml(goat.country) : ""}<br/>
            ${
              goat.subtitle
                ? `<div style="margin-top:4px;">${escapeHtml(goat.subtitle)}</div>`
                : ""
            }
            ${
              goat.link
                ? `<div style="margin-top:6px;"><a href="${goat.link}" target="_blank" rel="noopener noreferrer">View goat page</a></div>`
                : ""
            }
          </div>
        `;

        const marker = L.marker([goat.lat, goat.lng], { icon: markerIcon })
          .addTo(map)
          .bindPopup(popupHtml);

        markers.push(marker);
        bounds.push([goat.lat, goat.lng]);
      });

      if (bounds.length === 1) {
        map.setView(bounds[0], 5);
      } else if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    }

    // Listen for messages from Wix
    window.addEventListener("message", (event) => {
      try {
        const data =
          typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        if (!data || data.type !== "GOAT_LOCATIONS") return;

        const goats = Array.isArray(data.payload) ? data.payload : [];
        addGoatMarkers(goats);
      } catch (e) {
        console.error("Error handling message from parent:", e);
      }
    });

    // init empty dark map immediately
    initMap();

    function escapeHtml(str) {
      if (!str || typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
